<!DOCTYPE html>
<html>
		<head>
				<title>Rain</title>
				<meta charset='UTF-8' />
				<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
				<meta name="apple-mobile-web-app-capable" content="yes" />

				<link rel="shortcut icon" href="favicon.png" type="image/png" />
				<link rel="icon" href="favicon.png" type="image/png" />
				<link rel="apple-touch-icon" href="favicon.png" />

				<link rel="stylesheet" href="style/add2home.css">
				<link rel="stylesheet" href="style/style.css">
				<script type="text/javascript">
				var addToHomeConfig = {
					animationIn: 'bubble',
					animationOut: 'drop',
					lifespan:10000,
					expire:2,
					touchIcon:true
				};
				</script>
				<script type="application/javascript" src="code/add2home.js"></script>
			 
				<script src='prefixfree.min.js'></script>
				<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
		</head>
		<body>
			<header>
				<h1 id="city"></h1>
			</header>
			<ul id="forecast"></ul>     
			<div id="msg" class="row detailes"></div>
			<footer class="light">
				<div class="row detailes">2 hour rain forecast provided by <a id="source" href="http://buienradar.nl/">Buienradar</a></div>
				<div class="row detailes"><a href="http://xyrah.sytes.net/rain.php">http://xyrah.sytes.net/rain.php</a></div>
				<div id="forecastSource" class="row detailes"></div>
			</footer>


		<script>
				$(function() {

						function getCurrentCity( position ){
							$.ajax({
							  url: "getCurrentCity.php?lat=" + position.coords.latitude + "&lon=" + position.coords.longitude,
							  dataType: 'json',
							  success: function( data ){
							  	if(data){

								  	$(data.results[0].address_components).each( function() {
								  		if( this.types.indexOf("locality") >=0)
								  			$("#city").html( this.short_name );
								  		if(this.types.indexOf("country") >=0 )
								  			$("#city").html( $("#city").html() + ", " + this.short_name);
								  	});

							  	} else {
							  		$("#msg").html("Could not determine position");
							  	}
							  }
							});
						}

						function getForecast(position){
							$.ajax({
							  url: "getForecast.php?lat=" + position.coords.latitude + "&lon=" + position.coords.longitude,
							  dataType: 'text',
							  success: function( data ){

								if(data){
									
									//msg.html(' (ready.)');
									beaufity( $.trim(data).split(/\s+/g) );

								} else {
									msg.html(' (error!)');
									msg.addClass('error');
									var errormsg = '<p>Error: could not load the page.</p>';
									console.log(errormsg);
								}
							  },
							  complete: function(data) {
							  	console.log(data);
							  }
							});
						}

				function checkValue(value) {
					if(value == 0) { 		 return 'no rain'; }
					else if(value <= 0.25) { return 'light rain'; }
					else if(value <= 10) {   return 'moderate rain'; }
					else if(value <= 50) {   return 'heavy rain'; }
					else if(value > 50) {    return 'violent rain'; }
				}

				function beaufity( forecastSource ) {
					
					$('#msg').hide();

					forecastSource.splice(0,2); //remove past prediction

					$(forecastSource).each(function(i){
						var length = this.length;
						var amount255 = parseInt( this.substr(0, this.indexOf('|')) );
							if(amount255) {
								var ammount = Math.pow(10, ( amount255 - 109 ) / 32); // formula provided by forecast distributor

								ammount = Math.round( ammount * 10000 ) / 10000; //get the first 4 decimals
							}
							else
								var ammount = 0;

						var time = this.substr( this.indexOf('|')+1 );


						$('<li class="row">\
								<div class="detailes">\
									<span class="forecast strong">'+ checkValue(ammount) +'</span>\
									&nbsp;\
									<span class="ammount light">'+ (ammount?ammount+'mm':'') +'</span>\
									<span class="time strong">'+ time +'</span>\
								</div>\
								<div class="graphic-ammount" style="width: '+ Math.min(amount255/2.55,100) +'%"></div>\
							</li>').appendTo("#forecast");
					});

					$("#forecastSource").html( String(forecastSource) );
					setInterval(refresh, 300000);
				}

				function refresh(){
					//get current position
					navigator.geolocation.getCurrentPosition( function ( position ) {

						console.log( position );

					    getCurrentCity( position );
					    getForecast(position);
					},
					function ( error ) {
					    $("#msg").html("Could not get GPS position");
					} );
				}
				refresh();

				});
		</script>

		<script>
			//google analytics
			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-16398396-1']);
			_gaq.push(['_trackPageview']);

			(function() {
					var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
					ga.src = ('https: ' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
					var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			})();
		</script>
	</body>
</html>
â€‹